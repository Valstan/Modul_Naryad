–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞:
conftest.py
main.py
print_proekt.py
db\backup.py
db\database.py
db\queries.py
gui\base_form.py
gui\dialogs.py
gui\employees_form.py
gui\main_window.py
gui\work_order_form.py
gui\work_types_form.py
reports\excel_report.py
reports\html_report.py
reports\pdf_report.py
tests\test_database.py
utils\excel_handler.py
utils\validators.py

--------------------------------------------------------------------------------

–ü—É—Ç—å: conftest.py
–ò–º—è —Ñ–∞–π–ª–∞: conftest.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# conftest.py (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π
root_dir = Path(__file__).parent
sys.path.append(str(root_dir))
--------------------------------------------------------------------------------
–ü—É—Ç—å: main.py
–ò–º—è —Ñ–∞–π–ª–∞: main.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# main.py
import sys
from db.backup import BackupManager
from gui.dialogs import show_error
from gui.main_window import MainWindow

def main() -> None:
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É."""
    try:
        # –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        BackupManager("work_orders.db").create_backup()

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GUI
        app = MainWindow()
        app.mainloop()

    except Exception as e:
        show_error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
--------------------------------------------------------------------------------
–ü—É—Ç—å: print_proekt.py
–ò–º—è —Ñ–∞–π–ª–∞: print_proekt.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
import os

def create_project_map(project_root):
    project_map = []
    for root, dirs, files in os.walk(project_root):
        if '.venv' in dirs:
            dirs.remove('.venv')  # –ò—Å–∫–ª—é—á–∞–µ–º –ø–∞–ø–∫—É .venv –∏–∑ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        for file in files:
            if file.endswith('.py'):
                file_path = os.path.join(root, file)
                project_map.append(os.path.relpath(file_path, project_root))
    return project_map

project_root = os.getcwd()  # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
output_file = os.path.join(project_root, "project_contents.txt")

# –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –ø—Ä–æ–µ–∫—Ç–∞
project_map = create_project_map(project_root)

with open(output_file, 'w', encoding='utf-8') as f:
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø—Ä–æ–µ–∫—Ç–∞
    f.write("–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞:\n")
    for file_path in project_map:
        f.write(f"{file_path}\n")
    f.write('\n' + '-' * 80 + '\n\n')

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
    for file_path in project_map:
        full_path = os.path.join(project_root, file_path)
        with open(full_path, 'r', encoding='utf-8') as src_file:
            content = src_file.read()

        f.write(f"–ü—É—Ç—å: {file_path}\n")
        f.write(f"–ò–º—è —Ñ–∞–π–ª–∞: {os.path.basename(file_path)}\n")
        f.write("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n")
        f.write(content)
        f.write('\n' + '-' * 80 + '\n')

print(f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª: {output_file}")
--------------------------------------------------------------------------------
–ü—É—Ç—å: db\backup.py
–ò–º—è —Ñ–∞–π–ª–∞: backup.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# db/backup.py
import os
import shutil
from pathlib import Path
from datetime import datetime
from typing import Optional


class BackupManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏ –ë–î —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞."""

    def __init__(self, db_path: str, backup_dir: str = "backups", max_backups: int = 20):
        self.db_path = Path(db_path)
        self.backup_dir = Path(backup_dir)
        self.max_backups = max_backups

        if not self.db_path.exists():
            raise FileNotFoundError(f"–§–∞–π–ª –ë–î {db_path} –Ω–µ –Ω–∞–π–¥–µ–Ω!")

        self._ensure_backup_dir()

    def _ensure_backup_dir(self) -> None:
        """–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π."""
        self.backup_dir.mkdir(exist_ok=True, parents=True)

    def create_backup(self) -> Optional[str]:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
        try:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_path = self.backup_dir / f"backup_{timestamp}.db"

            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            shutil.copy2(str(self.db_path), str(backup_path))
            self._cleanup_old_backups()
            return str(backup_path)

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}")
            return None

    def _cleanup_old_backups(self) -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–ø–∏–π, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç."""
        backups = sorted(
            self.backup_dir.glob("backup_*.db"),
            key=lambda x: x.stat().st_mtime,
            reverse=False
        )

        while len(backups) > self.max_backups:
            old_backup = backups.pop(0)
            os.remove(str(old_backup))
--------------------------------------------------------------------------------
–ü—É—Ç—å: db\database.py
–ò–º—è —Ñ–∞–π–ª–∞: database.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# db/database.py
import logging
import sqlite3
from pathlib import Path
from typing import Optional, List, Tuple, Any

logger = logging.getLogger(__name__)


class Database:
    """Singleton –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ SQLite."""
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._init_db()
        return cls._instance

    def _init_db(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞ –∏ —Ç–∞–±–ª–∏—Ü."""
        self.db_path = Path("work_orders.db")
        self.conn = sqlite3.connect(str(self.db_path))
        self.conn.execute("PRAGMA foreign_keys = ON")
        self._create_tables()

    def _create_tables(self) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ."""
        tables = [
            """CREATE TABLE IF NOT EXISTS employees (
                id INTEGER PRIMARY KEY,
                employee_id TEXT UNIQUE NOT NULL,
                full_name TEXT NOT NULL,
                workshop_number INTEGER NOT NULL,
                position TEXT NOT NULL
            )""",

            """CREATE TABLE IF NOT EXISTS work_types (
                id INTEGER PRIMARY KEY,
                name TEXT UNIQUE NOT NULL,
                unit TEXT NOT NULL,
                price REAL NOT NULL CHECK(price > 0)
            )""",

            """CREATE TABLE IF NOT EXISTS products (
                id INTEGER PRIMARY KEY,
                name TEXT NOT NULL,
                product_code TEXT UNIQUE NOT NULL
            )""",

            """CREATE TABLE IF NOT EXISTS contracts (
                id INTEGER PRIMARY KEY,
                contract_code TEXT UNIQUE NOT NULL,
                start_date TEXT NOT NULL,
                end_date TEXT NOT NULL,
                description TEXT
            )""",

            """CREATE TABLE IF NOT EXISTS work_orders (
                id INTEGER PRIMARY KEY,
                order_date TEXT NOT NULL,
                product_id INTEGER NOT NULL,
                contract_id INTEGER NOT NULL,
                total_amount REAL NOT NULL,
                FOREIGN KEY(product_id) REFERENCES products(id),
                FOREIGN KEY(contract_id) REFERENCES contracts(id)
            )""",

            """CREATE TABLE IF NOT EXISTS order_workers (
                order_id INTEGER NOT NULL,
                worker_id INTEGER NOT NULL,
                PRIMARY KEY(order_id, worker_id),
                FOREIGN KEY(order_id) REFERENCES work_orders(id),
                FOREIGN KEY(worker_id) REFERENCES employees(id)
            )""",

            """CREATE TABLE IF NOT EXISTS order_work_types (
                order_id INTEGER NOT NULL,
                work_type_id INTEGER NOT NULL,
                quantity INTEGER NOT NULL CHECK(quantity > 0),
                amount REAL NOT NULL,
                PRIMARY KEY(order_id, work_type_id),
                FOREIGN KEY(order_id) REFERENCES work_orders(id),
                FOREIGN KEY(work_type_id) REFERENCES work_types(id)
            )"""
        ]

        cursor = self.conn.cursor()
        try:
            for table in tables:
                cursor.execute(table)
            self.conn.commit()
        except sqlite3.Error as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {str(e)}")
            self.conn.rollback()
        finally:
            cursor.close()

    def execute_query(
            self,
            query: str,
            params: Optional[Tuple[Any, ...]] = None
    ) -> Optional[List[Tuple[Any, ...]]]:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π."""
        cursor = self.conn.cursor()
        try:
            cursor.execute("BEGIN TRANSACTION")
            if params:
                cursor.execute(query, params)
            else:
                cursor.execute(query)
            result = cursor.fetchall()
            self.conn.commit()
            return result
        except sqlite3.Error as e:
            self.conn.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {str(e)}")
            return None
        finally:
            cursor.close()

    def __del__(self) -> None:
        """–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞."""
        if hasattr(self, "conn"):
            self.conn.close()

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
    def _create_indexes(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        indexes = [
            "CREATE INDEX IF NOT EXISTS idx_orders_date ON work_orders(order_date)",
            "CREATE INDEX IF NOT EXISTS idx_workers_name ON employees(full_name)",
            "CREATE INDEX IF NOT EXISTS idx_contracts_code ON contracts(contract_code)"
        ]

        cursor = self.conn.cursor()
        try:
            for index in indexes:
                cursor.execute(index)
            self.conn.commit()
        except sqlite3.Error as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: {str(e)}")
--------------------------------------------------------------------------------
–ü—É—Ç—å: db\queries.py
–ò–º—è —Ñ–∞–π–ª–∞: queries.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# db/queries.py
REPORT_BASE_QUERY = """
SELECT
    wo.id AS order_id,
    wo.order_date,
    p.name AS product,
    c.contract_code,
    SUM(owt.amount) AS total_amount,
    GROUP_CONCAT(e.full_name, ', ') AS workers
FROM work_orders wo
LEFT JOIN products p ON wo.product_id = p.id
LEFT JOIN contracts c ON wo.contract_id = c.id
LEFT JOIN order_workers ow ON wo.id = ow.order_id
LEFT JOIN employees e ON ow.worker_id = e.id
LEFT JOIN order_work_types owt ON wo.id = owt.order_id
GROUP BY wo.id
"""

WORK_ORDERS_FOR_PDF_HTML = """
SELECT
    wo.id AS order_id,
    wo.order_date,
    p.name AS product,
    c.contract_code,
    SUM(owt.amount) AS total_amount
FROM work_orders wo
LEFT JOIN products p ON wo.product_id = p.id
LEFT JOIN contracts c ON wo.contract_id = c.id
LEFT JOIN order_work_types owt ON wo.id = owt.order_id
GROUP BY wo.id
"""
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\base_form.py
–ò–º—è —Ñ–∞–π–ª–∞: base_form.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/base_form.py
import customtkinter as ctk
from tkinter import ttk
from typing import List, Optional, Tuple
from db.database import Database


class BaseForm(ctk.CTkFrame):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º —Å —Ç–∞–±–ª–∏—Ü–µ–π –∏ –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""

    def __init__(self, parent: ctk.CTkFrame, db: Database, columns: List[str]):
        super().__init__(parent)
        self.db = db
        self.columns = columns
        self._setup_ui()

    def _setup_ui(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
        # –¢–∞–±–ª–∏—Ü–∞
        self.table = ttk.Treeview(
            self,
            columns=self.columns,
            show="headings",
            style="Custom.Treeview"
        )
        for col in self.columns:
            self.table.heading(col, text=col)
        self.table.pack(expand=True, fill="both", padx=10, pady=10)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.btn_frame = ctk.CTkFrame(self)
        self.btn_frame.pack(pady=10)

        self.add_btn = ctk.CTkButton(self.btn_frame, text="–î–æ–±–∞–≤–∏—Ç—å", command=self._add_item)
        self.add_btn.pack(side="left", padx=5)

        self.edit_btn = ctk.CTkButton(self.btn_frame, text="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", command=self._edit_item)
        self.edit_btn.pack(side="left", padx=5)

        self.delete_btn = ctk.CTkButton(self.btn_frame, text="–£–¥–∞–ª–∏—Ç—å", command=self._delete_item)
        self.delete_btn.pack(side="left", padx=5)

    def _load_data(self, query: str, params: Optional[Tuple] = None) -> None:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –≤ —Ç–∞–±–ª–∏—Ü—É."""
        for row in self.table.get_children():
            self.table.delete(row)
        data = self.db.execute_query(query, params)
        for item in data:
            self.table.insert("", "end", values=item)

    def _add_item(self) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö)."""
        raise NotImplementedError

    def _edit_item(self) -> None:
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö)."""
        raise NotImplementedError

    def _delete_item(self) -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–ª–∞—Å—Å–∞—Ö)."""
        raise NotImplementedError
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\dialogs.py
–ò–º—è —Ñ–∞–π–ª–∞: dialogs.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/dialogs.py
from tkinter import ttk

import customtkinter as ctk
from tkcalendar import Calendar
from datetime import datetime
from typing import List, Optional, Tuple
from db.database import Database


class DatePickerDialog(ctk.CTkToplevel):
    """–î–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã."""

    def __init__(self, parent: ctk.CTkFrame) -> None:
        super().__init__(parent)
        self.title("–í—ã–±–æ—Ä –¥–∞—Ç—ã")
        self.geometry("300x200")
        self.resizable(False, False)
        self._selected_date: Optional[datetime] = None

        # –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–∑ tkcalendar
        self.calendar = Calendar(self, selectmode="day", date_pattern="dd.mm.yyyy")
        self.calendar.pack(pady=10)

        # –ö–Ω–æ–ø–∫–∏
        self.btn_frame = ctk.CTkFrame(self)
        self.btn_frame.pack(pady=10)

        self.ok_btn = ctk.CTkButton(self.btn_frame, text="OK", command=self._on_ok)
        self.ok_btn.pack(side="left", padx=5)

        self.cancel_btn = ctk.CTkButton(self.btn_frame, text="–û—Ç–º–µ–Ω–∞", command=self.destroy)
        self.cancel_btn.pack(side="right", padx=5)

    def _on_ok(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã."""
        try:
            self._selected_date = datetime.strptime(self.calendar.get_date(), "%d.%m.%Y")
            self.destroy()
        except ValueError:
            self._selected_date = None

    def get_date(self) -> Optional[datetime]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É."""
        return self._selected_date


class WorkerSelectionDialog(ctk.CTkToplevel):
    """–î–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—á–∏—Ö."""

    def __init__(self, parent: ctk.CTkFrame, db: Database) -> None:
        super().__init__(parent)
        self.title("–í—ã–±–æ—Ä —Ä–∞–±–æ—á–∏—Ö")
        self.geometry("600x400")
        self.db = db
        self._selected_ids: List[int] = []
        self._setup_ui()

    def _setup_ui(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
        # –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        self.tree = ttk.Treeview(self, columns=("id", "name", "workshop"), show="headings")
        self.tree.heading("id", text="–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ")
        self.tree.heading("name", text="–§–ò–û")
        self.tree.heading("workshop", text="–¶–µ—Ö")
        self.tree.pack(expand=True, fill="both", padx=10, pady=10)

        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        workers = self.db.execute_query("SELECT employee_id, full_name, workshop_number FROM employees")
        for worker in workers:
            self.tree.insert("", "end", values=worker)

        # –ö–Ω–æ–ø–∫–∏
        self.btn_frame = ctk.CTkFrame(self)
        self.btn_frame.pack(pady=10)

        self.select_btn = ctk.CTkButton(self.btn_frame, text="–í—ã–±—Ä–∞—Ç—å", command=self._on_select)
        self.select_btn.pack(side="left", padx=5)

        self.cancel_btn = ctk.CTkButton(self.btn_frame, text="–û—Ç–º–µ–Ω–∞", command=self.destroy)
        self.cancel_btn.pack(side="right", padx=5)

    def _on_select(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö."""
        selected_items = self.tree.selection()
        self._selected_ids = [int(self.tree.item(item)["values"][0]) for item in selected_items]
        self.destroy()

    def get_selected_workers(self) -> List[int]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö."""
        return self._selected_ids


def show_error(message: str) -> None:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–∫–Ω–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ."""
    dialog = ctk.CTkToplevel()
    dialog.title("–û—à–∏–±–∫–∞")
    dialog.geometry("400x100")

    label = ctk.CTkLabel(dialog, text=message, text_color="red")
    label.pack(pady=20)

    btn = ctk.CTkButton(dialog, text="OK", command=dialog.destroy)
    btn.pack(pady=5)


def show_info(message: str) -> None:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    dialog = ctk.CTkToplevel()
    dialog.title("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
    dialog.geometry("400x100")

    label = ctk.CTkLabel(dialog, text=message)
    label.pack(pady=20)

    btn = ctk.CTkButton(dialog, text="OK", command=dialog.destroy)
    btn.pack(pady=5)
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\employees_form.py
–ò–º—è —Ñ–∞–π–ª–∞: employees_form.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/employees_form.py
from typing import Optional

import customtkinter as ctk
from db.database import Database
from gui.base_form import BaseForm
from gui.dialogs import show_error, show_info
from utils.validators import validate_unique_employee_id


class EmployeesForm(BaseForm):
    """–§–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤."""

    def __init__(self, parent: ctk.CTkFrame, db: Database):
        columns = ["–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ", "–§–ò–û", "–¶–µ—Ö", "–î–æ–ª–∂–Ω–æ—Å—Ç—å"]
        super().__init__(parent, db, columns)
        self._load_data("SELECT employee_id, full_name, workshop_number, position FROM employees")

    def _add_item(self) -> None:
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞."""
        dialog = EmployeeDialog(self, self.db)
        if dialog.result:
            self._load_data("SELECT employee_id, full_name, workshop_number, position FROM employees")

    def _edit_item(self) -> None:
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞."""
        selected = self.table.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞!")
            return

        employee_data = self.table.item(selected[0])["values"]
        dialog = EmployeeDialog(self, self.db, employee_data)
        if dialog.result:
            self._load_data("SELECT employee_id, full_name, workshop_number, position FROM employees")

    def _delete_item(self) -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞."""
        selected = self.table.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞!")
            return

        employee_id = self.table.item(selected[0])["values"][0]
        self.db.execute_query("DELETE FROM employees WHERE employee_id = ?", (employee_id,))
        self._load_data("SELECT employee_id, full_name, workshop_number, position FROM employees")


class EmployeeDialog(ctk.CTkToplevel):
    """–î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞."""

    def __init__(self, parent: ctk.CTkFrame, db: Database, data: Optional[list] = None):
        super().__init__(parent)
        self.db = db
        self.result = False
        self.title("–î–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞" if not data else "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞")
        self.geometry("400x300")

        # –ü–æ–ª—è –≤–≤–æ–¥–∞
        self.employee_id = ctk.CTkEntry(self, placeholder_text="–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ")
        self.full_name = ctk.CTkEntry(self, placeholder_text="–§–ò–û")
        self.workshop = ctk.CTkEntry(self, placeholder_text="–¶–µ—Ö")
        self.position = ctk.CTkEntry(self, placeholder_text="–î–æ–ª–∂–Ω–æ—Å—Ç—å")

        # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        if data:
            self.employee_id.insert(0, str(data[1]))  # data[1] = employee_id –≤ —Ç–∞–±–ª–∏—Ü–µ
            self.full_name.insert(0, data[2])
            self.workshop.insert(0, str(data[3]))
            self.position.insert(0, data[4])

        # –†–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        self.employee_id.pack(pady=5)
        self.full_name.pack(pady=5)
        self.workshop.pack(pady=5)
        self.position.pack(pady=5)

        # –ö–Ω–æ–ø–∫–∏
        btn_frame = ctk.CTkFrame(self)
        btn_frame.pack(pady=10)

        ctk.CTkButton(btn_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=self._save).pack(side="left", padx=5)
        ctk.CTkButton(btn_frame, text="–û—Ç–º–µ–Ω–∞", command=self.destroy).pack(side="right", padx=5)

    def _save(self) -> None:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–∞."""
        employee_id = self.employee_id.get().strip()
        full_name = self.full_name.get().strip()
        workshop = self.workshop.get().strip()
        position = self.position.get().strip()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not all([employee_id, full_name, workshop, position]):
            show_error("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!")
            return

        if not validate_unique_employee_id(employee_id, self.db):
            show_error("–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º!")
            return

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        query = """
            INSERT INTO employees (employee_id, full_name, workshop_number, position)
            VALUES (?, ?, ?, ?)
            ON CONFLICT(employee_id) DO UPDATE SET
                full_name = excluded.full_name,
                workshop_number = excluded.workshop_number,
                position = excluded.position
        """
        self.db.execute_query(query, (employee_id, full_name, workshop, position))
        self.result = True
        self.destroy()
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\main_window.py
–ò–º—è —Ñ–∞–π–ª–∞: main_window.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/main_window.py
import logging
from pathlib import Path
from tkinter import filedialog
from typing import Optional

import customtkinter as ctk

from db.database import Database
from gui.dialogs import show_error, show_info
from gui.employees_form import EmployeesForm
from gui.work_order_form import WorkOrderForm
from gui.work_types_form import WorkTypesForm
from reports.excel_report import ExcelReportGenerator
from utils.excel_handler import ExcelHandler

logger = logging.getLogger(__name__)


class MainWindow(ctk.CTk):
    """–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–∞–Ω–Ω—ã—Ö."""

    def __init__(self) -> None:
        super().__init__()
        self.title("–£—á–µ—Ç —Å–¥–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç")
        self.geometry("1200x800")
        self.db = Database()
        self._load_filters_data()

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        ctk.set_appearance_mode("light")
        ctk.set_default_color_theme("green")
        self._init_ui()

    def _init_ui(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
        try:
            self.tabview = ctk.CTkTabview(self)
            self._create_tabs()
            self._init_import_export_buttons()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: {str(e)}")
            show_error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞")

    def _create_tabs(self) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
        tabs = ["–ù–∞—Ä—è–¥—ã", "–†–∞–±–æ—Ç–Ω–∏–∫–∏", "–í–∏–¥—ã —Ä–∞–±–æ—Ç", "–û—Ç—á–µ—Ç—ã"]
        for tab in tabs:
            self.tabview.add(tab)
        self.tabview.pack(expand=True, fill="both", padx=20, pady=20)

        self._init_work_orders_tab()
        self._init_employees_tab()
        self._init_work_types_tab()
        self._init_reports_tab()

    def _load_filters_data(self) -> None:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –æ—à–∏–±–∫–∏."""
        try:
            self.contracts = self._safe_query("SELECT contract_code FROM contracts") or []
            self.products = self._safe_query("SELECT name FROM products") or []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤")

    def _safe_query(self, query: str) -> Optional[list]:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
        result = self.db.execute_query(query)
        if result is None:
            logger.warning(f"–ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {query}")
        return result

    def _init_work_orders_tab(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å –Ω–∞—Ä—è–¥–∞–º–∏."""
        try:
            tab = self.tabview.tab("–ù–∞—Ä—è–¥—ã")
            WorkOrderForm(tab, self.db)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞—Ä—è–¥–æ–≤: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –Ω–∞—Ä—è–¥–æ–≤")

    def _init_employees_tab(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏."""
        try:
            tab = self.tabview.tab("–†–∞–±–æ—Ç–Ω–∏–∫–∏")
            EmployeesForm(tab, self.db)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–∫–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤")

    def _init_work_types_tab(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ —Å –≤–∏–¥–∞–º–∏ —Ä–∞–±–æ—Ç."""
        try:
            tab = self.tabview.tab("–í–∏–¥—ã —Ä–∞–±–æ—Ç")
            WorkTypesForm(tab, self.db)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç")

    def _init_reports_tab(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ —Å –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é."""
        try:
            tab = self.tabview.tab("–û—Ç—á–µ—Ç—ã")
            btn_frame = ctk.CTkFrame(tab)
            btn_frame.pack(pady=20)

            ctk.CTkButton(
                btn_frame,
                text="–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å Excel-–æ—Ç—á–µ—Ç",
                command=self._generate_excel_report
            ).pack(side="left", padx=10)

            ctk.CTkButton(
                btn_frame,
                text="–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PDF-–æ—Ç—á–µ—Ç",
                command=self._generate_pdf_report
            ).pack(side="left", padx=10)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –æ—Ç—á–µ—Ç–æ–≤: {str(e)}")

    def _generate_excel_report(self) -> None:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel-–æ—Ç—á–µ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
        try:
            generator = ExcelReportGenerator(self.db)
            report_path = generator.generate()
            if report_path:
                show_info(f"–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {report_path}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel-–æ—Ç—á–µ—Ç–∞: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞")

    def _generate_pdf_report(self) -> None:
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF-–æ—Ç—á–µ—Ç–∞."""
        show_info("PDF-–æ—Ç—á–µ—Ç—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")

    def _init_import_export_buttons(self) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞."""
        self._add_buttons_to_tab("–†–∞–±–æ—Ç–Ω–∏–∫–∏")
        self._add_buttons_to_tab("–í–∏–¥—ã —Ä–∞–±–æ—Ç")

    def _add_buttons_to_tab(self, tab_name: str) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å Excel."""
        try:
            tab = self.tabview.tab(tab_name)
            btn_frame = ctk.CTkFrame(tab)
            btn_frame.pack(pady=10)

            ctk.CTkButton(
                btn_frame,
                text="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel",
                command=lambda: self._export_data(tab_name)
            ).pack(side="left", padx=5)

            ctk.CTkButton(
                btn_frame,
                text="–ò–º–ø–æ—Ä—Ç –∏–∑ Excel",
                command=lambda: self._import_data(tab_name)
            ).pack(side="right", padx=5)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è {tab_name}: {str(e)}")

    def _export_data(self, table_name: str) -> None:
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
        try:
            file_path = filedialog.asksaveasfilename(
                defaultextension=".xlsx",
                filetypes=[("Excel Files", "*.xlsx")]
            )
            if not file_path:
                return

            handler = ExcelHandler(self.db)
            if handler.export_table(table_name.lower(), Path(file_path)):
                show_info("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
            else:
                show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö")

    def _import_data(self, table_name: str) -> None:
        """–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞."""
        try:
            file_path = filedialog.askopenfilename(
                filetypes=[("Excel Files", "*.xlsx")]
            )
            if not file_path:
                return

            handler = ExcelHandler(self.db)
            success, msg = handler.import_table(table_name.lower(), Path(file_path))
            if success:
                show_info(msg)
                self._reload_current_tab()
            else:
                show_error(msg)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö")

    def _reload_current_tab(self) -> None:
        """–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö."""
        current_tab = self.tabview.get()
        try:
            if current_tab == "–†–∞–±–æ—Ç–Ω–∏–∫–∏":
                self._init_employees_tab()
            elif current_tab == "–í–∏–¥—ã —Ä–∞–±–æ—Ç":
                self._init_work_types_tab()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏: {str(e)}")


if __name__ == "__main__":
    app = MainWindow()
    app.mainloop()
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\work_order_form.py
–ò–º—è —Ñ–∞–π–ª–∞: work_order_form.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/work_order_form.py
import logging
from datetime import datetime
from typing import List, Dict, Optional, Tuple

import customtkinter as ctk
from tkinter import ttk

from db.database import Database
from gui.dialogs import DatePickerDialog, WorkerSelectionDialog, show_error, show_info
from utils.validators import validate_date, validate_positive_number

logger = logging.getLogger(__name__)


class WorkOrderForm(ctk.CTkFrame):
    """–§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ä—è–¥–æ–≤ —Ä–∞–±–æ—Ç —Å –ø–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."""

    def __init__(self, parent: ctk.CTkFrame, db: Database) -> None:
        super().__init__(parent)
        self.db = db
        self._current_workers: List[int] = []
        self._current_works: List[Dict] = []
        self._setup_ui()
        self._load_initial_data()

    def _setup_ui(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ–º–ø–æ–Ω–æ–≤–∫–æ–π."""
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(3, weight=1)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        ctk.CTkLabel(self, text="–ù–æ–≤—ã–π –Ω–∞—Ä—è–¥ —Ä–∞–±–æ—Ç", font=("Arial", 14, "bold")).grid(
            row=0, column=0, columnspan=3, pady=10, sticky="w"
        )

        # –ü–æ–ª—è –≤–≤–æ–¥–∞
        self._create_input_fields()
        self._create_workers_section()
        self._create_works_table()
        self._create_total_section()
        self._create_control_buttons()

    def _create_input_fields(self) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—è–¥–∞."""
        # –î–∞—Ç–∞ –Ω–∞—Ä—è–¥–∞
        ctk.CTkLabel(self, text="–î–∞—Ç–∞:").grid(row=1, column=0, sticky="e", padx=5)
        self.date_entry = ctk.CTkEntry(self)
        self.date_entry.insert(0, datetime.now().strftime("%d.%m.%Y"))
        self.date_entry.grid(row=1, column=1, sticky="ew", padx=5)

        ctk.CTkButton(
            self,
            text="üìÖ",
            width=30,
            command=self._open_date_picker
        ).grid(row=1, column=2, padx=5)

        # –í—ã–±–æ—Ä –∏–∑–¥–µ–ª–∏—è –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        self._create_combobox("–ò–∑–¥–µ–ª–∏–µ:", "products", row=2)
        self._create_combobox("–ö–æ–Ω—Ç—Ä–∞–∫—Ç:", "contracts", row=3)

    def _create_combobox(self, label: str, table: str, row: int) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π."""
        ctk.CTkLabel(self, text=label).grid(row=row, column=0, sticky="e", padx=5)
        values = self._get_combobox_values(table)
        combobox = ctk.CTkComboBox(self, values=values)
        combobox.grid(row=row, column=1, sticky="ew", padx=5, pady=2)
        setattr(self, f"{table}_combobox", combobox)

    def _get_combobox_values(self, table: str) -> List[str]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤."""
        try:
            if table == "products":
                result = self.db.execute_query("SELECT id, name FROM products")
            elif table == "contracts":
                result = self.db.execute_query("SELECT id, contract_code FROM contracts")
            return [f"{row[0]} - {row[1]}" for row in result] if result else []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {table}: {str(e)}")
            return []

    def _load_initial_data(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤."""
        try:
            products = self.db.execute_query("SELECT id, name FROM products")
            contracts = self.db.execute_query("SELECT id, contract_code FROM contracts")

            self.products_combobox.configure(
                values=[f"{p[0]} - {p[1]}" for p in products] if products else []
            )
            self.contracts_combobox.configure(
                values=[f"{c[0]} - {c[1]}" for c in contracts] if contracts else []
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤")

    def _create_workers_section(self) -> None:
        """–°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—á–∏—Ö –±—Ä–∏–≥–∞–¥—ã."""
        self.workers_btn = ctk.CTkButton(
            self,
            text="–í—ã–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–∏—Ö (0)",
            command=self._select_workers
        )
        self.workers_btn.grid(row=4, column=0, columnspan=3, pady=10, sticky="ew")

    def _create_works_table(self) -> None:
        """–¢–∞–±–ª–∏—Ü–∞ –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º."""
        columns = ("–í–∏–¥ —Ä–∞–±–æ—Ç—ã", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–¶–µ–Ω–∞", "–°—É–º–º–∞")
        self.works_table = ttk.Treeview(
            self,
            columns=columns,
            show="headings",
            style="Custom.Treeview",
            height=6
        )

        for col in columns:
            self.works_table.heading(col, text=col)
            self.works_table.column(col, width=120, anchor="center")

        self.works_table.grid(row=5, column=0, columnspan=3, sticky="nsew", pady=10)

    def _create_total_section(self) -> None:
        """–°–µ–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã."""
        ctk.CTkLabel(self, text="–ò—Ç–æ–≥–æ:").grid(row=6, column=0, sticky="e", padx=5)
        self.total_value = ctk.CTkLabel(self, text="0.00 ‚ÇΩ")
        self.total_value.grid(row=6, column=1, sticky="w", padx=5)

    def _create_control_buttons(self) -> None:
        """–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Ä—è–¥–æ–º."""
        btn_frame = ctk.CTkFrame(self)
        btn_frame.grid(row=7, column=0, columnspan=3, pady=10)

        ctk.CTkButton(
            btn_frame,
            text="–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É",
            command=self._add_work
        ).pack(side="left", padx=5)

        ctk.CTkButton(
            btn_frame,
            text="–£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É",
            command=self._remove_work
        ).pack(side="left", padx=5)

        ctk.CTkButton(
            btn_frame,
            text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Ä—è–¥",
            command=self._save_order
        ).pack(side="right", padx=5)

    def _open_date_picker(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."""
        dialog = DatePickerDialog(self)
        date = dialog.get_date()
        if date:
            self.date_entry.delete(0, "end")
            self.date_entry.insert(0, date.strftime("%d.%m.%Y"))

    def _select_workers(self) -> None:
        """–í—ã–±–æ—Ä —Ä–∞–±–æ—á–∏—Ö —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞."""
        dialog = WorkerSelectionDialog(self, self.db)
        workers = dialog.get_selected_workers()
        if workers:
            self._current_workers = workers
            self.workers_btn.configure(text=f"–í—ã–±—Ä–∞–Ω–æ: {len(workers)} —Ä–∞–±–æ—á–∏—Ö")

    def _add_work(self) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ."""
        try:
            work_types = self.db.execute_query(
                "SELECT id, name, price FROM work_types"
            )
            if not work_types:
                show_error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç")
                return

            dialog = WorkTypeSelectionDialog(self, work_types)
            selected = dialog.get_selected_work()
            if selected:
                self._current_works.append({
                    "type_id": selected[0],
                    "name": selected[1],
                    "price": selected[2],
                    "quantity": selected[3]
                })
                self._update_works_table()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç")

    def _update_works_table(self) -> None:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º —Å—É–º–º."""
        for row in self.works_table.get_children():
            self.works_table.delete(row)

        total = 0.0
        for work in self._current_works:
            amount = work["price"] * work["quantity"]
            self.works_table.insert("", "end", values=(
                work["name"],
                work["quantity"],
                f"{work['price']:.2f} ‚ÇΩ",
                f"{amount:.2f} ‚ÇΩ"
            ))
            total += amount

        self.total_value.configure(text=f"{total:.2f} ‚ÇΩ")

    def _remove_work(self) -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã."""
        selected = self.works_table.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return

        index = self.works_table.index(selected[0])
        del self._current_works[index]
        self._update_works_table()

    def _save_order(self) -> None:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Ä—è–¥–∞ —Å –ø–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª–µ–π
            errors = self._validate_basic_fields()
            if errors:
                show_error("\n".join(errors))
                return

            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            product_id = self._get_selected_id("products")
            contract_id = self._get_selected_id("contracts")
            if not product_id or not contract_id:
                show_error("–ù–µ –≤—ã–±—Ä–∞–Ω–æ –∏–∑–¥–µ–ª–∏–µ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç")
                return

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
            order_id = self._save_to_database(product_id, contract_id)
            self._save_related_data(order_id)

            show_info("–ù–∞—Ä—è–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
            self._clear_form()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Ä—è–¥–∞: {str(e)}")
            show_error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö")

    def _validate_basic_fields(self) -> List[str]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã."""
        errors = []
        if not validate_date(self.date_entry.get()):
            errors.append("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (–¥–¥.–º–º.–≥–≥–≥–≥)")
        if not self._current_workers:
            errors.append("–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ")
        if not self._current_works:
            errors.append("–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –≤–∏–¥ —Ä–∞–±–æ—Ç")
        return errors

    def _get_selected_id(self, field: str) -> Optional[int]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ –∫–æ–º–±–æ–±–æ–∫—Å–∞."""
        value = getattr(self, f"{field}_combobox").get()
        return int(value.split(" - ")[0]) if value else None

    def _save_to_database(self, product_id: int, contract_id: int) -> int:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –Ω–∞—Ä—è–¥–∞ –≤ –ë–î."""
        total = sum(work["price"] * work["quantity"] for work in self._current_works)

        result = self.db.execute_query(
            """INSERT INTO work_orders 
               (order_date, product_id, contract_id, total_amount)
               VALUES (?, ?, ?, ?)
               RETURNING id""",
            (self.date_entry.get(), product_id, contract_id, total)
        )

        if not result:
            raise ValueError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Ä—è–¥–∞")
        return result[0][0]

    def _save_related_data(self, order_id: int) -> None:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –∏ –≤–∏–¥—ã —Ä–∞–±–æ—Ç)."""
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö
        workers_data = [(order_id, worker_id) for worker_id in self._current_workers]
        self.db.execute_query(
            "INSERT INTO order_workers (order_id, worker_id) VALUES (?, ?)",
            workers_data,
            many=True
        )

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç
        works_data = [
            (order_id, work["type_id"], work["quantity"], work["price"] * work["quantity"])
            for work in self._current_works
        ]
        self.db.execute_query(
            """INSERT INTO order_work_types 
               (order_id, work_type_id, quantity, amount)
               VALUES (?, ?, ?, ?)""",
            works_data,
            many=True
        )

    def _clear_form(self) -> None:
        """–û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."""
        self.date_entry.delete(0, "end")
        self.date_entry.insert(0, datetime.now().strftime("%d.%m.%Y"))
        self.products_combobox.set("")
        self.contracts_combobox.set("")
        self._current_workers = []
        self._current_works = []
        self.workers_btn.configure(text="–í—ã–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–∏—Ö (0)")
        self._update_works_table()


class WorkTypeSelectionDialog(ctk.CTkToplevel):
    """–î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞."""

    def __init__(self, parent: ctk.CTkFrame, work_types: List[Tuple]):
        super().__init__(parent)
        self.title("–í—ã–±–æ—Ä –≤–∏–¥–∞ —Ä–∞–±–æ—Ç")
        self.geometry("400x300")
        self._selected = None

        # –¢–∞–±–ª–∏—Ü–∞ –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç
        self.tree = ttk.Treeview(
            self,
            columns=("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–¶–µ–Ω–∞"),
            show="headings"
        )
        self.tree.heading("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", text="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ")
        self.tree.heading("–¶–µ–Ω–∞", text="–¶–µ–Ω–∞ –∑–∞ –µ–¥.")
        self.tree.pack(expand=True, fill="both", padx=10, pady=10)

        for wt in work_types:
            self.tree.insert("", "end", values=(wt[1], f"{wt[2]:.2f} ‚ÇΩ"), tags=(wt[0],))

        # –ü–æ–ª–µ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        self.quantity_entry = ctk.CTkEntry(self, placeholder_text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ")
        self.quantity_entry.pack(pady=5)

        # –ö–Ω–æ–ø–∫–∏
        btn_frame = ctk.CTkFrame(self)
        btn_frame.pack(pady=10)

        ctk.CTkButton(
            btn_frame,
            text="–í—ã–±—Ä–∞—Ç—å",
            command=self._on_select
        ).pack(side="left", padx=5)

        ctk.CTkButton(
            btn_frame,
            text="–û—Ç–º–µ–Ω–∞",
            command=self.destroy
        ).pack(side="right", padx=5)

    def _on_select(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""
        selected = self.tree.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞–±–æ—Ç")
            return

        try:
            quantity = int(self.quantity_entry.get())
            if quantity <= 0:
                raise ValueError
        except ValueError:
            show_error("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ")
            return

        self._selected = (
            int(self.tree.item(selected[0], "tags")[0]),  # ID
            self.tree.item(selected[0], "values")[0],  # –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
            float(self.tree.item(selected[0], "values")[1].split()[0]),  # –¶–µ–Ω–∞
            quantity
        )
        self.destroy()

    def get_selected_work(self) -> Optional[Tuple]:
        return self._selected
--------------------------------------------------------------------------------
–ü—É—Ç—å: gui\work_types_form.py
–ò–º—è —Ñ–∞–π–ª–∞: work_types_form.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# gui/work_types_form.py
from typing import Optional

import customtkinter as ctk

from db.database import Database
from gui.base_form import BaseForm
from gui.dialogs import show_error
from utils.validators import validate_unique_work_type_name


class WorkTypesForm(BaseForm):
    """–§–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∞–º–∏ —Ä–∞–±–æ—Ç."""

    def __init__(self, parent: ctk.CTkFrame, db: Database):
        columns = ["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è", "–¶–µ–Ω–∞ (—Ä—É–±)"]
        super().__init__(parent, db, columns)
        self._load_data("SELECT name, unit, price FROM work_types")

    def _add_item(self) -> None:
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""
        dialog = WorkTypeDialog(self, self.db)
        if dialog.result:
            self._load_data("SELECT name, unit, price FROM work_types")

    def _edit_item(self) -> None:
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""
        selected = self.table.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞–±–æ—Ç!")
            return

        work_data = self.table.item(selected[0])["values"]
        dialog = WorkTypeDialog(self, self.db, work_data)
        if dialog.result:
            self._load_data("SELECT name, unit, price FROM work_types")

    def _delete_item(self) -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""
        selected = self.table.selection()
        if not selected:
            show_error("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–∞–±–æ—Ç!")
            return

        work_name = self.table.item(selected[0])["values"][0]
        self.db.execute_query("DELETE FROM work_types WHERE name = ?", (work_name,))
        self._load_data("SELECT name, unit, price FROM work_types")


class WorkTypeDialog(ctk.CTkToplevel):
    """–î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""

    def __init__(self, parent: ctk.CTkFrame, db: Database, data: Optional[list] = None):
        super().__init__(parent)
        self.db = db
        self.result = False
        self.title("–ù–æ–≤—ã–π –≤–∏–¥ —Ä–∞–±–æ—Ç" if not data else "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
        self.geometry("400x250")

        # –ü–æ–ª—è –≤–≤–æ–¥–∞
        self.name_entry = ctk.CTkEntry(self, placeholder_text="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ*")
        self.unit_combobox = ctk.CTkComboBox(self, values=["—à—Ç—É–∫–∏", "–∫–æ–º–ø–ª–µ–∫—Ç—ã"])
        self.price_entry = ctk.CTkEntry(self, placeholder_text="–¶–µ–Ω–∞*")

        # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if data:
            self.name_entry.insert(0, data[0])
            self.unit_combobox.set(data[1])
            self.price_entry.insert(0, str(data[2]))

        # –†–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        self.name_entry.pack(pady=5)
        self.unit_combobox.pack(pady=5)
        self.price_entry.pack(pady=5)

        # –ö–Ω–æ–ø–∫–∏
        btn_frame = ctk.CTkFrame(self)
        btn_frame.pack(pady=10)

        ctk.CTkButton(btn_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=self._save).pack(side="left", padx=5)
        ctk.CTkButton(btn_frame, text="–û—Ç–º–µ–Ω–∞", command=self.destroy).pack(side="right", padx=5)

    def _save(self) -> None:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö."""
        name = self.name_entry.get().strip()
        unit = self.unit_combobox.get()
        price = self.price_entry.get().strip()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not all([name, unit, price]):
            show_error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!")
            return

        if not validate_unique_work_type_name(name, self.db):
            show_error("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º!")
            return

        try:
            price = float(price)
        except ValueError:
            show_error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–Ω—ã!")
            return

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        query = """
            INSERT INTO work_types (name, unit, price)
            VALUES (?, ?, ?)
            ON CONFLICT(name) DO UPDATE SET
                unit = excluded.unit,
                price = excluded.price
        """
        self.db.execute_query(query, (name, unit, price))
        self.result = True
        self.destroy()
--------------------------------------------------------------------------------
–ü—É—Ç—å: reports\excel_report.py
–ò–º—è —Ñ–∞–π–ª–∞: excel_report.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# reports/excel_report.py
import pandas as pd
from pathlib import Path
from datetime import datetime
from db.database import Database
from db.queries import REPORT_BASE_QUERY
from typing import Optional, Dict
import logging

logger = logging.getLogger(__name__)


class ExcelReportGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel."""

    def __init__(self, db: Database) -> None:
        self.db = db
        self._output_dir = Path("reports/excel")
        self._output_dir.mkdir(exist_ok=True, parents=True)

    def generate(
            self,
            filters: Optional[Dict] = None,
            filename: Optional[str] = None
    ) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö."""
        try:
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
            data = self.db.execute_query(REPORT_BASE_QUERY)
            if not data:
                logger.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞")
                return None

            # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
            df = pd.DataFrame(
                data,
                columns=["order_id", "order_date", "product", "contract_code",
                         "total_amount", "workers"]
            )

            # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if filters:
                df = self._apply_filters(df, filters)

            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            output_path = self._get_output_path(filename)
            df.to_excel(output_path, index=False)
            return str(output_path)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel-–æ—Ç—á–µ—Ç–∞: {str(e)}")
            return None

    def _apply_filters(self, df: pd.DataFrame, filters: Dict) -> pd.DataFrame:
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∫ –¥–∞–Ω–Ω—ã–º."""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏...
        return df

    def _get_output_path(self, filename: Optional[str]) -> Path:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É."""
        if filename:
            return self._output_dir / filename
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        return self._output_dir / f"report_{timestamp}.xlsx"
--------------------------------------------------------------------------------
–ü—É—Ç—å: reports\html_report.py
–ò–º—è —Ñ–∞–π–ª–∞: html_report.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# reports/html_report.py
from pathlib import Path
from datetime import datetime
from db.database import Database
from db.queries import WORK_ORDERS_FOR_PDF_HTML
from typing import Optional, Dict
import logging

logger = logging.getLogger(__name__)


class HTMLReportGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML."""

    def __init__(self, db: Database) -> None:
        self.db = db
        self._output_dir = Path("reports/html")
        self._output_dir.mkdir(exist_ok=True, parents=True)

    def generate(self, filters: Optional[Dict] = None, filename: Optional[str] = None) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-–æ—Ç—á–µ—Ç."""
        try:
            data = self.db.execute_query(WORK_ORDERS_FOR_PDF_HTML)
            if not data:
                logger.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞")
                return None

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
            html_content = self._build_html(data)

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            output_path = self._get_output_path(filename)
            with open(output_path, "w", encoding="utf-8") as f:
                f.write(html_content)

            return str(output_path)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML-–æ—Ç—á–µ—Ç–∞: {str(e)}")
            return None

    def _build_html(self, data: list) -> str:
        """–°–æ–∑–¥–∞–µ—Ç HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä—É."""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è HTML...
        return "<html>...</html>"

    def _get_output_path(self, filename: Optional[str]) -> Path:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É."""
        if filename:
            return self._output_dir / filename
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        return self._output_dir / f"report_{timestamp}.html"
--------------------------------------------------------------------------------
–ü—É—Ç—å: reports\pdf_report.py
–ò–º—è —Ñ–∞–π–ª–∞: pdf_report.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# reports/pdf_report.py
import logging
from datetime import datetime
from pathlib import Path
from typing import Dict, Optional, List, Tuple

from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm
from reportlab.platypus import (
    SimpleDocTemplate,
    Table,
    TableStyle,
    Paragraph,
    Spacer
)

from db.database import Database
from db.queries import WORK_ORDERS_FOR_PDF_HTML
from utils.validators import validate_date_range

logger = logging.getLogger(__name__)


class PDFReportGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä PDF-–æ—Ç—á–µ—Ç–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏."""

    def __init__(self, db: Database):
        self.db = db
        self._output_dir = Path("reports/pdf")
        self._output_dir.mkdir(exist_ok=True, parents=True)
        self.styles = self._create_custom_styles()

    def generate(
            self,
            filters: Optional[Dict] = None,
            filename: Optional[str] = None
    ) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF-–æ—Ç—á–µ—Ç —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤."""
        try:
            data = self._get_filtered_data(filters)
            if not data:
                logger.warning("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞")
                return None

            output_path = self._get_output_path(filename)
            doc = SimpleDocTemplate(
                str(output_path),
                pagesize=A4,
                leftMargin=2 * cm,
                rightMargin=2 * cm
            )

            elements = []
            self._add_header(elements)
            self._add_filters_info(elements, filters)
            self._add_data_table(elements, data)
            self._add_footer(elements)

            doc.build(elements)
            return str(output_path)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: {str(e)}")
            return None

    def _get_filtered_data(self, filters: Optional[Dict]) -> List[Tuple]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤."""
        query = WORK_ORDERS_FOR_PDF_HTML
        params = []

        if filters:
            where_clauses = []
            for key, value in filters.items():
                if value:
                    if key == "date_range":
                        if validate_date_range(value["start"], value["end"]):
                            where_clauses.append(
                                "order_date BETWEEN ? AND ?"
                            )
                            params.extend([value["start"], value["end"]])
                    elif key == "contract":
                        where_clauses.append("contract_code = ?")
                        params.append(value)
                    elif key == "product":
                        where_clauses.append("product_name = ?")
                        params.append(value)
                    elif key == "worker":
                        where_clauses.append("workers LIKE ?")
                        params.append(f"%{value}%")

            if where_clauses:
                query += " WHERE " + " AND ".join(where_clauses)

        return self.db.execute_query(query, tuple(params)) or []

    def _create_custom_styles(self) -> Dict:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –¥–ª—è –æ—Ç—á–µ—Ç–∞."""
        styles = getSampleStyleSheet()
        styles.add(ParagraphStyle(
            name="Title",
            fontSize=14,
            leading=16,
            alignment=1,
            spaceAfter=12
        ))
        styles.add(ParagraphStyle(
            name="Footer",
            fontSize=8,
            textColor=colors.grey,
            alignment=2
        ))
        return styles

    def _add_header(self, elements: List) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞."""
        title = Paragraph(
            "–û—Ç—á–µ—Ç –ø–æ –Ω–∞—Ä—è–¥–∞–º —Ä–∞–±–æ—Ç",
            self.styles["Title"]
        )
        elements.append(title)
        elements.append(Spacer(1, 0.5 * cm))

    def _add_filters_info(self, elements: List, filters: Dict) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö."""
        if filters:
            filter_text = "–ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: " + ", ".join(
                [f"{k}: {v}" for k, v in filters.items() if v]
            )
            elements.append(Paragraph(filter_text, self.styles["Normal"]))
            elements.append(Spacer(1, 0.2 * cm))

    def _add_data_table(self, elements: List, data: List[Tuple]) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∞–Ω–Ω—ã–º–∏."""
        headers = [
            "–ù–∞—Ä—è–¥ ‚Ññ",
            "–î–∞—Ç–∞",
            "–ò–∑–¥–µ–ª–∏–µ",
            "–ö–æ–Ω—Ç—Ä–∞–∫—Ç",
            "–°—É–º–º–∞",
            "–†–∞–±–æ—á–∏–µ"
        ]

        table_data = [headers]
        for row in data:
            formatted_row = [
                str(row[0]),
                datetime.strptime(row[1], "%Y-%m-%d").strftime("%d.%m.%Y"),
                row[2],
                row[3],
                f"{row[4]:,.2f} ‚ÇΩ".replace(",", " "),
                ", ".join(row[5].split(", "))
            ]
            table_data.append(formatted_row)

        table = Table(
            table_data,
            colWidths=[2 * cm, 2.5 * cm, 4 * cm, 4 * cm, 3 * cm, 6 * cm],
            repeatRows=1
        )

        table.setStyle(TableStyle([
            ("BACKGROUND", (0, 0), (-1, 0), colors.lightgrey),
            ("TEXTCOLOR", (0, 0), (-1, 0), colors.black),
            ("ALIGN", (0, 0), (-1, -1), "CENTER"),
            ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
            ("FONTSIZE", (0, 0), (-1, 0), 10),
            ("BOTTOMPADDING", (0, 0), (-1, 0), 12),
            ("GRID", (0, 0), (-1, -1), 1, colors.black),
            ("VALIGN", (0, 0), (-1, -1), "MIDDLE"),
        ]))

        elements.append(table)

    def _add_footer(self, elements: List) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–≤–∞–ª–∞ –æ—Ç—á–µ—Ç–∞."""
        footer_text = Paragraph(
            f"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}",
            self.styles["Footer"]
        )
        elements.append(Spacer(1, 1 * cm))
        elements.append(footer_text)

    def _get_output_path(self, filename: Optional[str]) -> Path:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞."""
        if filename:
            return self._output_dir / filename
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        return self._output_dir / f"report_{timestamp}.pdf"
--------------------------------------------------------------------------------
–ü—É—Ç—å: tests\test_database.py
–ò–º—è —Ñ–∞–π–ª–∞: test_database.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
import sqlite3

import pytest
from pathlib import Path
from db.database import Database
from db.backup import BackupManager

TEST_DB_PATH = "test_work_orders.db"


@pytest.fixture(scope="function")
def test_db():
    """–§–∏–∫—Å—Ç—É—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î."""
    db_path = Path(TEST_DB_PATH)

    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –ë–î
    if db_path.exists():
        db_path.unlink(missing_ok=True)

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ë–î
    db = Database()
    db.db_path = TEST_DB_PATH
    db._init_db()  # –°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ Path.touch()

    # –Ø–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –¥–∞–Ω–Ω—ã—Ö
    with db.conn:
        cursor = db.conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS employees (
                id INTEGER PRIMARY KEY,
                employee_id TEXT UNIQUE NOT NULL,
                full_name TEXT NOT NULL,
                workshop_number INTEGER NOT NULL,
                position TEXT NOT NULL
            )
        """)
        cursor.execute(
            "INSERT INTO employees (employee_id, full_name, workshop_number, position) VALUES (?, ?, ?, ?)",
            ("dummy", "–¢–µ—Å—Ç", 0, "–¢–µ—Å—Ç")
        )
        db.conn.commit()

    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Ñ–∞–π–ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è
    db.conn.close()

    yield db

    # –£–¥–∞–ª–µ–Ω–∏–µ –ë–î
    if db_path.exists():
        db_path.unlink()


def test_create_tables(test_db):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü."""
    # –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
    test_db.conn = sqlite3.connect(TEST_DB_PATH)
    test_db.execute_query("DELETE FROM employees")

    test_db.execute_query(
        "INSERT INTO employees (employee_id, full_name, workshop_number, position) VALUES (?, ?, ?, ?)",
        ("001", "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω", 1, "–ò–Ω–∂–µ–Ω–µ—Ä")
    )
    result = test_db.execute_query("SELECT * FROM employees")
    assert len(result) == 1, "–î–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É."
    test_db.conn.close()


def test_backup_manager(test_db):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π."""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ë–î
    assert Path(TEST_DB_PATH).exists(), "–§–∞–π–ª –ë–î –Ω–µ —Å–æ–∑–¥–∞–Ω!"

    # –°–æ–∑–¥–∞–Ω–∏–µ BackupManager
    manager = BackupManager(TEST_DB_PATH, backup_dir="test_backups", max_backups=2)
    backup_path = manager.create_backup()

    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    assert backup_path is not None, "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞."
    assert Path(backup_path).exists(), "–§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."

    # –û—á–∏—Å—Ç–∫–∞
    for file in Path("test_backups").glob("*.db"):
        file.unlink()
    Path("test_backups").rmdir()
--------------------------------------------------------------------------------
–ü—É—Ç—å: utils\excel_handler.py
–ò–º—è —Ñ–∞–π–ª–∞: excel_handler.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# utils/excel_handler.py
import pandas as pd
from pathlib import Path
from typing import Optional, List, Dict
from db.database import Database
import logging

logger = logging.getLogger(__name__)


class ExcelHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel."""

    def __init__(self, db: Database):
        self.db = db
        self.supported_tables = {
            "employees": ("–§–ò–û", "–ù–æ–º–µ—Ä —Ü–µ—Ö–∞", "–î–æ–ª–∂–Ω–æ—Å—Ç—å", "–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä"),
            "work_types": ("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è", "–¶–µ–Ω–∞")
        }

    def export_table(self, table_name: str, output_path: Path) -> bool:
        """–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã –ë–î –≤ Excel."""
        if table_name not in self.supported_tables:
            logger.error(f"–¢–∞–±–ª–∏—Ü–∞ {table_name} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
            return False

        try:
            data = self.db.execute_query(f"SELECT * FROM {table_name}")
            if not data:
                return False

            df = pd.DataFrame(data, columns=self.supported_tables[table_name])
            df.to_excel(output_path, index=False)
            return True

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: {str(e)}")
            return False

    def import_table(self, table_name: str, file_path: Path) -> tuple[bool, str]:
        """–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel –≤ –ë–î."""
        if table_name not in self.supported_tables:
            return (False, f"–¢–∞–±–ª–∏—Ü–∞ {table_name} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")

        try:
            df = pd.read_excel(file_path)
            if not self._validate_columns(df, table_name):
                return (False, "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞")

            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            for _, row in df.iterrows():
                self._process_row(table_name, row)

            return (True, "–£—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç")

        except Exception as e:
            return (False, f"–û—à–∏–±–∫–∞: {str(e)}")

    def _validate_columns(self, df: pd.DataFrame, table_name: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤."""
        expected = set(self.supported_tables[table_name])
        actual = set(df.columns)
        return expected == actual

    def _process_row(self, table_name: str, row: pd.Series) -> None:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö."""
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        if table_name == "employees":
            self.db.execute_query(
                """INSERT INTO employees (full_name, workshop_number, position, employee_id)
                   VALUES (?, ?, ?, ?)
                   ON CONFLICT(employee_id) DO NOTHING""",
                (row["–§–ò–û"], row["–ù–æ–º–µ—Ä —Ü–µ—Ö–∞"], row["–î–æ–ª–∂–Ω–æ—Å—Ç—å"], row["–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä"])
            )
--------------------------------------------------------------------------------
–ü—É—Ç—å: utils\validators.py
–ò–º—è —Ñ–∞–π–ª–∞: validators.py
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
# utils/validators.py
from datetime import datetime
from db.database import Database
from typing import Optional, Tuple


def validate_date(date_str: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY."""
    try:
        datetime.strptime(date_str, "%d.%m.%Y")
        return True
    except ValueError:
        return False


def validate_positive_number(value: str, is_float: bool = False) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º (—Ü–µ–ª—ã–º –∏–ª–∏ –¥—Ä–æ–±–Ω—ã–º)."""
    try:
        number = float(value) if is_float else int(value)
        return number > 0
    except (ValueError, TypeError):
        return False


def validate_unique(field: str, value: str, table: str, db: Database) -> bool:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ."""
    result = db.execute_query(
        f"SELECT COUNT(*) FROM {table} WHERE {field} = ?",
        (value,)
    )
    return result[0][0] == 0 if result else False


def validate_unique_employee_id(employee_id: str, db: Database) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–∞–±–µ–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞."""
    return validate_unique("employee_id", employee_id, "employees", db)


def validate_unique_contract_code(code: str, db: Database) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —à–∏—Ñ—Ä–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞."""
    return validate_unique("contract_code", code, "contracts", db)


def validate_unique_work_type_name(name: str, db: Database) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤–∏–¥–∞ —Ä–∞–±–æ—Ç."""
    return validate_unique("name", name, "work_types", db)


def validate_order_data(
        date: str,
        workers: list,
        works: list,
        db: Database
) -> Tuple[bool, Optional[str]]:
    """–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—è–¥–∞."""
    errors = []

    if not validate_date(date):
        errors.append("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")

    if not workers:
        errors.append("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ")

    for work in works:
        if not validate_positive_number(str(work["quantity"])):
            errors.append("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")

    return (False, "\n".join(errors)) if errors else (True, None)
--------------------------------------------------------------------------------
